<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PaperTrading â€” Paper Investing (GBP)</title>
  <meta name="apple-mobile-web-app-title" content="PaperTrading">
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel3:#0b1220;
      --text:#e7eefc; --muted:#9bb0d0; --line:#1f2a3d; --good:#27e69a; --bad:#ff6b6b;
      --accent1:#00d084; --accent2:#1b7cff;
    }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{ margin:0; background:linear-gradient(180deg,#070a0f,#0b0f14 30%); color:var(--text); }
    .app{ display:grid; grid-template-columns: 290px 1fr; min-height:100vh; }
    @media (max-width: 920px){ .app{ grid-template-columns: 1fr; } }
    .sidebar{
      position:sticky; top:0; height:100vh;
      background:linear-gradient(180deg,var(--panel),#0d1320);
      border-right:1px solid var(--line);
      padding:16px;
    }
    @media (max-width: 920px){ .sidebar{ position:relative; height:auto; border-right:none; border-bottom:1px solid var(--line);} }
    .brand{ display:flex; gap:10px; align-items:center; margin-bottom:14px; }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      display:grid; place-items:center; font-weight:1000; letter-spacing:.3px;
    }
    .brandTitle{ font-weight:1000; letter-spacing:.3px; }
    .brandSub{ color:var(--muted); font-size:12px; margin-top:2px; }
    .nav{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .nav button{
      width:100%; text-align:left; padding:10px 12px;
      border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.02);
      color:var(--text); cursor:pointer; font-weight:900;
    }
    .nav button.active{ background:linear-gradient(135deg,rgba(0,208,132,.18),rgba(27,124,255,.18)); border-color:rgba(27,124,255,.35); }
    .pillRow{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
    .pill{
      padding:10px 12px; border:1px solid var(--line); border-radius:14px; background:var(--panel3);
      display:flex; justify-content:space-between; align-items:center; font-size:13px; color:var(--muted);
    }
    .pill b{ color:var(--text); }
    .badge{ display:inline-flex; gap:8px; align-items:center; }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent1); box-shadow:0 0 12px rgba(0,208,132,.8); }
    .dot.off{ background:#6f86aa; box-shadow:none; }
    .main{ padding:16px; }
    .topbar{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .search{
      flex:1; min-width:260px;
      display:flex; gap:10px; align-items:center;
      background:var(--panel3); border:1px solid var(--line); border-radius:14px; padding:10px 12px;
    }
    .search input{
      width:100%; border:none; background:transparent; color:var(--text); outline:none; font-size:14px;
    }
    .btn{
      border-radius:12px; border:1px solid var(--line); padding:10px 12px;
      background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:var(--text);
      font-weight:1000; cursor:pointer;
    }
    .btn.ghost{ background:var(--panel3); font-weight:900; }
    .btn.danger{ background:linear-gradient(135deg,#ff4d4d,#ff9a3d); border:none; }
    .grid{ display:grid; grid-template-columns: 1.25fr .75fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background:linear-gradient(180deg,var(--panel),#0d1320);
      border:1px solid var(--line); border-radius:18px; padding:14px;
    }
    h2{ margin:0 0 10px 0; font-size:15px; letter-spacing:.2px; }
    h3{ margin:0 0 10px 0; font-size:14px; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:13px; }
    .small{ font-size:12px; color:#93a9ce; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .right{ text-align:right; }
    table{ width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; }
    th, td{ text-align:left; padding:10px 10px; border-bottom:1px solid var(--line); font-size:13px; }
    th{ color:#bcd0f7; font-weight:1000; background:var(--panel3); }
    tr:hover td{ background:rgba(255,255,255,.02); }
    .pos{ color:var(--good); font-weight:1000; }
    .neg{ color:var(--bad); font-weight:1000; }
    .tag{
      padding:8px 10px; border:1px solid var(--line); border-radius:16px; font-size:12px;
      color:var(--muted); background:var(--panel3); display:flex; gap:10px; align-items:flex-start;
      min-width: 240px; cursor:pointer;
    }
    .tag b{ color:var(--text); }
    .tag .col{ display:flex; flex-direction:column; gap:4px; }
    .tag .price{ font-weight:1000; color:var(--text); }
    .tag .x{ margin-left:auto; color:var(--muted); cursor:pointer; }
    .toast{
      margin-top:10px; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:var(--panel3); color:#cfe0ff; font-size:13px; display:none;
    }
    .toast.show{ display:block; }
    .assetHeader{
      display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin-bottom:10px;
    }
    .assetLeft{ display:flex; flex-direction:column; gap:6px; }
    .assetSym{ font-size:18px; font-weight:1100; letter-spacing:.4px; }
    .assetName{ font-size:13px; color:var(--muted); }
    .assetPrice{ font-size:22px; font-weight:1100; }
    .assetChange{ font-size:13px; font-weight:1000; }
    .sparkWrap{ background:var(--panel3); border:1px solid var(--line); border-radius:14px; padding:10px; }
    canvas{ display:block; width:100%; height:100px; }
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
      padding:16px; z-index:50;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(720px, 100%); background:linear-gradient(180deg,var(--panel),#0d1320);
      border:1px solid var(--line); border-radius:18px; padding:14px;
    }
    .modalTop{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .xbtn{ background:transparent; border:1px solid var(--line); color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer; }
    .form{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .form{ grid-template-columns:1fr; } }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field input, .field select{
      border-radius:12px; border:1px solid var(--line); background:var(--panel3); color:var(--text);
      padding:10px 12px; outline:none;
    }
    .kpis{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .kpi{ border:1px solid var(--line); border-radius:14px; background:var(--panel3); padding:10px 12px; }
    .kpi .muted{ font-size:12px; }
    .kpi b{ font-size:14px; }
    .warn{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,154,61,.35);
      background:rgba(255,154,61,.08);
      color:#ffd4b8; font-size:12px;
    }
    .ok{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(39,230,154,.25);
      background:rgba(39,230,154,.06);
      color:#ccffe9; font-size:12px;
    }
  
    .globalToast{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:9999;
      padding:12px 14px; border-radius:14px; border:1px solid var(--line);
      background:rgba(11,18,32,.95); color:#cfe0ff; font-size:13px;
      display:none;
      backdrop-filter: blur(8px);
    }
    .globalToast.show{ display:block; }
    .modalError{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.08);
      color:#ffd2d2; font-size:12px; display:none;
    }
    .modalError.show{ display:block; }

  
    body[data-theme="light"]{
      --bg:#f5f7fb; --panel:#ffffff; --panel3:#f0f3f9;
      --text:#0b1220; --muted:#51627f; --line:#d7deea; --good:#0a8f5b; --bad:#c23a3a;
      --accent1:#00b879; --accent2:#2a67ff;
      background:linear-gradient(180deg,#ffffff,#f5f7fb 30%);
    }
    body[data-theme="light"] .toast, 
    body[data-theme="light"] .globalToast{
      background:rgba(240,243,249,.98);
      color:#0b1220;
    }

  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">PT</div>
      <div>
        <div class="brandTitle">PaperTrading</div>
        <div class="brandSub">paper trading â€¢ real quotes â€¢ GBP</div>
      </div>
    </div>

    <div class="nav">
      <button id="navMarkets" class="active" onclick="showView('markets')">Markets</button>
      <button id="navDiscover" onclick="showView('discover')">Discover</button>
      <button id="navWatch" onclick="showView('watch')">Watchlist</button>
      <button id="navPort" onclick="showView('portfolio')">Portfolio</button>
      <button id="navHist" onclick="showView('history')">History</button>
      <button class="btn ghost" style="margin-top:4px;" onclick="openTicket()">Trade</button>
    </div>

    <div class="pillRow">
      <div class="pill"><span class="badge"><span id="liveDot" class="dot off"></span><span id="liveText">Not updating</span></span><span></span></div>

      <div class="pill"><span>API</span><b id="apiStatus">DEMO</b></div>
      <div class="pill"><span>Mode</span><b id="modeStatus">DEMO</b></div>

      <div class="pill"><span>Cash</span><b id="cashTop">Â£0.00</b></div>
      <div class="pill"><span>Equity</span><b id="equityTop">Â£0.00</b></div>
      <div class="pill"><span>As of</span><span id="asOf" class="muted">â€”</span></div>

      <div class="pill"><span>Session P/L</span><b id="sessionPL">Â£0.00</b></div>
      <div class="pill"><span>Session Start</span><span id="sessionStart" class="muted">â€”</span></div>

    </div>

    <div class="card" style="margin-top:12px; padding:12px; background:var(--panel3);">
      <h3 style="margin-bottom:8px;">Live Setup</h3>
      <div class="field">
        <label class="muted">Polygon API Key</label>
        <input id="apiKey" placeholder="API_KEY" />
      </div>
      <div class="field" style="margin-top:10px;">
        <label class="muted">Refresh interval</label>
        <select id="interval">
          <option value="1000">1 second (fast)</option>
          <option value="2000">2 seconds</option>
          <option value="5000" selected>5 seconds (recommended)</option>
          <option value="10000">10 seconds</option>
        </select>
      </div>

      <div class="field" style="margin-top:10px;">
        <label class="muted">Demo Mode (no API key needed)</label>
        <select id="demoMode">
          <option value="on">ON (simulated prices)</option>
          <option value="off">OFF (requires API)</option>
        </select>
      </div>
      <div class="small" style="margin-top:8px; color:#93a9ce;">
        Demo mode is great for testing on iPhone. Turn it OFF once your API key works.
      </div>

      <div class="field" style="margin-top:10px;">
        <label class="muted">Theme</label>
        <select id="themeMode">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </div>


      <div class="row" style="margin-top:10px;">
        <button class="btn" style="flex:1;" id="startBtn">Start</button>
        <button class="btn ghost" style="flex:1;" id="stopBtn">Stop</button>
      </div>
      <button class="btn ghost" style="width:100%; margin-top:10px;" id="testBtn">Test API / Refresh Now</button>

      <div class="warn">
        Holdings revalue at real market prices whenever the app refreshes.
        Updating while the app is closed needs a backend/push notifications (Safari/iOS wonâ€™t run this in the background).
      </div>
      <div class="ok">
        Tip: keep your watchlist small (10â€“25 symbols) for faster refreshes.
      </div>
    </div>

    <div class="card" style="margin-top:12px; padding:12px; background:var(--panel3);">
      <h3 style="margin-bottom:8px;">Virtual Funds</h3>
      <div class="row">
        <button class="btn ghost" onclick="addFunds(10000)">+ Â£10k</button>
        <button class="btn ghost" onclick="addFunds(50000)">+ Â£50k</button>
        <button class="btn ghost" onclick="addFunds(100000)">+ Â£100k</button>
      </div>
      <button class="btn danger" style="width:100%; margin-top:10px;" onclick="resetAccount()">Reset to Â£100,000</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span class="muted">ðŸ”Ž</span>
        <input id="globalSymbol" placeholder="Quick add symbol (AAPL, VOD, X:BTCUSD, C:XAUUSD)" />
      </div>
      <div class="row">
        <button class="btn ghost" onclick="quickAdd()">Add</button>
        <button class="btn ghost" onclick="refreshPrices()">Refresh</button>
        <button class="btn" onclick="openTicket()">Trade</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="assetHeader">
          <div class="assetLeft">
            <div class="assetSym" id="assetSym">AAPL</div>
            <div class="assetName" id="assetName">Apple Inc.</div>
            <div class="row" style="align-items:baseline;">
              <div class="assetPrice" id="assetPrice">Â£â€”</div>
              <div class="assetChange" id="assetChange">â€”</div>
            </div>
            <div class="muted small">Trade by Â£ amount. The app converts it into shares at the current price.</div>

            <div class="row" style="gap:8px; flex-wrap:wrap;">
              <span class="small" id="marketStatus">â€”</span>
              <span class="small" id="currencyNote">â€”</span>
            </div>

            <div class="row" style="gap:8px; margin-top:6px;">
              <button class="btn ghost" style="padding:6px 10px;" id="tf_1m">1m</button>
              <button class="btn ghost" style="padding:6px 10px;" id="tf_5m">5m</button>
              <button class="btn ghost" style="padding:6px 10px;" id="tf_1h">1h</button>
              <button class="btn ghost" style="padding:6px 10px;" id="tf_1d">1D</button>
            </div>

          </div>
          <div class="sparkWrap" style="width:min(520px, 100%);">
            <canvas id="spark" width="520" height="100"></canvas>
          </div>
        </div>

        <div id="viewMarkets">
          <h2>Markets (presets)</h2>
          <div class="muted">Tap to open:</div>
          <div class="row" style="margin-top:12px;">
            <span class="tag" onclick="setActiveSymbol('AAPL')">
              <div class="col"><b>AAPL</b><span class="small" id="nm_AAPL">Apple Inc.</span></div>
              <div class="col" style="align-items:flex-end;"><span class="price" id="px_AAPL">â€”</span><span class="small muted">tap</span></div>
            </span>
            <span class="tag" onclick="setActiveSymbol('TSLA')">
              <div class="col"><b>TSLA</b><span class="small" id="nm_TSLA">Tesla, Inc.</span></div>
              <div class="col" style="align-items:flex-end;"><span class="price" id="px_TSLA">â€”</span><span class="small muted">tap</span></div>
            </span>
            <span class="tag" onclick="setActiveSymbol('NVDA')">
              <div class="col"><b>NVDA</b><span class="small" id="nm_NVDA">NVIDIA Corporation</span></div>
              <div class="col" style="align-items:flex-end;"><span class="price" id="px_NVDA">â€”</span><span class="small muted">tap</span></div>
            </span>
            <span class="tag" onclick="setActiveSymbol('X:BTCUSD')">
              <div class="col"><b>X:BTCUSD</b><span class="small" id="nm_X:BTCUSD">Bitcoin / USD</span></div>
              <div class="col" style="align-items:flex-end;"><span class="price" id="px_X:BTCUSD">â€”</span><span class="small muted">tap</span></div>
            </span>
            <span class="tag" onclick="setActiveSymbol('C:XAUUSD')">
              <div class="col"><b>C:XAUUSD</b><span class="small" id="nm_C:XAUUSD">Gold / USD</span></div>
              <div class="col" style="align-items:flex-end;"><span class="price" id="px_C:XAUUSD">â€”</span><span class="small muted">tap</span></div>
            </span>
          </div>
          <div id="toast" class="toast"></div>
        </div>

        <div id="viewDiscover" style="display:none;">
          <h2>Discover</h2>
          <div class="muted">Search tickers, then add to Watchlist. Names will show everywhere once added.</div>
          <div class="row" style="margin-top:12px;">
            <div class="field" style="flex:1; min-width:240px;">
              <label class="muted">Search</label>
              <input id="discQuery" placeholder="e.g. Vodafone, BP, HSBC, Bitcoin" />
            </div>
            <div class="field" style="min-width:190px;">
              <label class="muted">Asset class</label>
              <select id="discAsset">
                <option value="stocks" selected>Stocks</option>
                <option value="crypto">Crypto</option>
                <option value="fx">FX / Metals</option>
              </select>
            </div>
            <div class="field" style="min-width:160px;">
              <label class="muted">Locale</label>
              <select id="discLocale">
                <option value="">Any</option>
                <option value="gb">GB (UK)</option>
                <option value="us">US</option>
              </select>
            </div>
            <button class="btn" style="height:42px; align-self:end;" onclick="discoverSearch(true)">Search</button>
          </div>

          <div id="discResults" class="card" style="margin-top:12px; padding:0; overflow:hidden;"></div>
          <div class="row" style="justify-content:space-between; margin-top:10px;">
            <button class="btn ghost" onclick="discoverPrev()">â—€ Prev</button>
            <div class="muted small" id="discPage">Page 1</div>
            <button class="btn ghost" onclick="discoverNext()">Next â–¶</button>
          </div>
        </div>

        <div id="viewWatch" style="display:none;">
          <h2>Watchlist</h2>
          <div class="muted">Names are shown under each symbol. Tap a card to open it.</div>
          <div class="row" style="margin-top:12px;" id="watchTags"></div>
        </div>

        <div id="viewPortfolio" style="display:none;">
          <h2>Portfolio</h2>
          <div class="muted">Holdings adjust to real prices on each refresh.</div>

          <div class="card" style="margin-top:10px; padding:12px; background:var(--panel3);">
            <div class="row" style="justify-content:space-between; gap:10px;">
              <div>
                <div class="muted small">Total Return</div>
                <div style="font-weight:1100; font-size:16px;" id="perfReturn">â€”</div>
              </div>
              <div>
                <div class="muted small">Unrealized P/L</div>
                <div style="font-weight:1100; font-size:16px;" id="perfUPL">â€”</div>
              </div>
              <div>
                <div class="muted small">Best / Worst</div>
                <div style="font-weight:1100; font-size:13px;" id="perfBestWorst">â€”</div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Instrument</th>
                  <th class="right">Shares</th>
                  <th class="right">Avg Cost</th>
                  <th class="right">Price</th>
                  <th class="right">Value</th>
                  <th class="right">Unreal P/L</th>
                </tr>
              </thead>
              <tbody id="portfolioBody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewHistory" style="display:none;">
          <h2>History</h2>
          <div class="muted">Latest 50 trades shown.</div>
          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Side</th>
                  <th>Instrument</th>
                  <th class="right">Â£ Amount</th>
                  <th class="right">Shares</th>
                  <th class="right">Price</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="card">
        <h2>Trade by Â£</h2>
        <div class="muted">Enter a money amount. We show the share conversion underneath.</div>
        <div class="row" style="margin-top:12px;">
          <button class="btn" style="flex:1;" onclick="openTicket('BUY')">Buy</button>
          <button class="btn ghost" style="flex:1;" onclick="openTicket('SELL')">Sell</button>
        </div>
        <div class="small" style="margin-top:10px;">
          Want background updates while the app is closed? That needs a tiny server + push/email alerts.
        </div>

        <div class="card" style="margin-top:12px; padding:12px; background:var(--panel3);">
          <h3>Price Alerts (local)</h3>
          <div class="muted small">Alerts trigger while the app is open.</div>
          <div class="row" style="margin-top:10px;">
            <input id="alertSym" placeholder="AAPL" style="flex:1; min-width:120px; border-radius:12px; border:1px solid var(--line); background:var(--panel3); color:var(--text); padding:10px 12px; outline:none;">
            <select id="alertDir" style="min-width:92px; border-radius:12px; border:1px solid var(--line); background:var(--panel3); color:var(--text); padding:10px 12px; outline:none;">
              <option value=">">></option>
              <option value="<"><</option>
            </select>
            <input id="alertPx" placeholder="200" inputmode="decimal" style="width:110px; border-radius:12px; border:1px solid var(--line); background:var(--panel3); color:var(--text); padding:10px 12px; outline:none;">
          </div>
          <button class="btn ghost" style="width:100%; margin-top:10px;" onclick="addAlert()">Add Alert</button>
          <div id="alertList" style="margin-top:10px;"></div>
        </div>

      </aside>
    </div>
  </main>
</div>

<div id="backdrop" class="backdrop" onclick="closeTicket(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalTop">
      <div>
        <div style="font-weight:1100; font-size:16px;">Order Ticket</div>
        <div class="muted small">Enter Â£ amount â€” shares are calculated at the latest fetched price.</div>
      </div>
      <button class="xbtn" onclick="closeTicket()">âœ•</button>
    </div>

    <div class="form">
      <div class="field">
        <label class="muted">Side</label>
        <select id="ticketSide">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
      </div>
      <div class="field">
        <label class="muted">Symbol</label>
        <input id="ticketSymbol" placeholder="AAPL / X:BTCUSD / C:XAUUSD" />
      </div>

      <div class="field">
        <label class="muted">Â£ Amount</label>
        <input id="ticketAmount" inputmode="decimal" placeholder="1000" />
      </div>
      <div class="field">
        <label class="muted">Current Price (GBP)</label>
        <input id="ticketPrice" disabled />
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="muted">Shares (calculated)</div>
        <b id="ticketSharesCalc">â€”</b>
      </div>
      <div class="kpi">
        <div class="muted">Cash after</div>
        <b id="cashAfter">â€”</b>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" style="flex:1;" onclick="submitTicket()">Place Order</button>
      <button class="btn ghost" style="flex:1;" onclick="closeTicket()">Cancel</button>
    </div>

    <div id="modalError" class="modalError"></div>

    <div class="warn">
      SELL: if Â£ amount is larger than your holdingâ€™s value, it sells the maximum possible.
    </div>
  </div>
</div>

<script>
  const KEY = {
    api: "papertrading_apiKey",
    cash: "papertrading_cash_gbp",
    pos: "papertrading_positions",
    hist: "papertrading_history",
    watch: "papertrading_watchlist",
    active: "papertrading_active_symbol",
    series: "papertrading_series",
    names: "papertrading_names",
    discState: "papertrading_disc_state",
    demo: "papertrading_demo_mode",
    demoPrices: "papertrading_demo_prices",
    startCash: "papertrading_start_cash",
    theme: "papertrading_theme",
    sessionStartEq: "papertrading_session_start_equity",
    sessionStartTs: "papertrading_session_start_ts",
    alerts: "papertrading_alerts",
    posOpened: "papertrading_pos_opened",
    timeframe: "papertrading_timeframe"
  };
  const DEFAULT_CASH = 100000;

  let timer = null;
  let lastPrices = {};
  let usdToGbpCache = null;
  let usdToGbpTs = 0;

  let lastNativeUSD = {}; // symbol -> native USD (or quote mid) before GBP conversion

  function getStartCash(){
    const v = localStorage.getItem(KEY.startCash);
    if(v===null){
      localStorage.setItem(KEY.startCash, String(DEFAULT_CASH));
      return DEFAULT_CASH;
    }
    return Number(v);
  }
  function setStartCash(v){ localStorage.setItem(KEY.startCash, String(v)); }

  function getDemoMode(){
    const v = localStorage.getItem(KEY.demo);
    if(v===null){
      localStorage.setItem(KEY.demo, "on");
      return "on";
    }
    return v;
  }
  function setDemoMode(v){
    localStorage.setItem(KEY.demo, v);
    const sel = document.getElementById("demoMode");
    if(sel) sel.value = v;
    updateStatusPills();
  }

  function getDemoPrices(){
    const raw = localStorage.getItem(KEY.demoPrices);
    return raw ? JSON.parse(raw) : {};
  }
  function setDemoPrices(p){
    localStorage.setItem(KEY.demoPrices, JSON.stringify(p));
  }

  function hashSeed(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return (h>>>0);
  }

  function ensureDemoSeed(symbols){
    const p = getDemoPrices();
    let changed = false;
    for(const s of symbols){
      if(p[s] == null){
        const seed = hashSeed(s);
        // base between 10 and 400 for stocks, higher for BTC, gold etc
        let base = 10 + (seed % 390);
        if(s.includes("BTC")) base = 25000 + (seed % 30000);
        if(s.includes("XAU")) base = 1500 + (seed % 1500);
        // store as GBP price directly for demo
        p[s] = base;
        changed = true;
      }
    }
    if(changed) setDemoPrices(p);
    return p;
  }

  function stepDemoPrices(symbols){
    const p = ensureDemoSeed(symbols);
    for(const s of symbols){
      const x = p[s];
      // random walk Â±0.35% per tick (scaled)
      const rnd = (Math.random() - 0.5) * 0.007;
      p[s] = Math.max(0.0001, x * (1 + rnd));
    }
    setDemoPrices(p);
    return p;
  }

  function updateStatusPills(){
    const apiKey = (document.getElementById("apiKey")?.value || "").trim();
    const demo = getDemoMode();
    const apiEl = document.getElementById("apiStatus");
    const modeEl = document.getElementById("modeStatus");
    if(apiEl){
      apiEl.textContent = apiKey ? "KEY SET" : (demo==="on" ? "DEMO" : "NO KEY");
    }
    if(modeEl){
      modeEl.textContent = demo==="on" ? "DEMO" : "LIVE";
    }
  }

  
  function getTheme(){
    const v = localStorage.getItem(KEY.theme);
    if(!v){ localStorage.setItem(KEY.theme, "dark"); return "dark"; }
    return v;
  }
  function setTheme(v){
    localStorage.setItem(KEY.theme, v);
    document.body.setAttribute("data-theme", v);
    const sel = document.getElementById("themeMode");
    if(sel) sel.value = v;
  }

  function getAlerts(){
    const raw = localStorage.getItem(KEY.alerts);
    return raw ? JSON.parse(raw) : [];
  }
  function setAlerts(a){ localStorage.setItem(KEY.alerts, JSON.stringify(a)); }

  function renderAlerts(){
    const box = document.getElementById("alertList");
    if(!box) return;
    const a = getAlerts();
    if(a.length===0){
      box.innerHTML = '<div class="muted small">No alerts yet.</div>';
      return;
    }
    box.innerHTML = a.map((it,i)=>`
      <div class="pill" style="margin-top:8px;">
        <span>${it.sym} ${it.dir} ${gbp(it.px)}</span>
        <span style="cursor:pointer;" onclick="removeAlert(${i})">âœ•</span>
      </div>
    `).join("");
  }
  function addAlert(){
    const sym = (document.getElementById("alertSym")?.value || "").trim().toUpperCase();
    const dir = document.getElementById("alertDir")?.value || ">";
    const px = Number(document.getElementById("alertPx")?.value);
    if(!sym || !isFinite(px) || px<=0){ toast("Enter symbol + target price."); return; }
    const a = getAlerts();
    a.push({sym, dir, px, fired:false});
    setAlerts(a);
    renderAlerts();
    toast(`Alert added: ${sym} ${dir} ${gbp(px)}`);
  }
  function removeAlert(i){
    const a = getAlerts();
    a.splice(i,1);
    setAlerts(a);
    renderAlerts();
  }
  function checkAlerts(){
    const a = getAlerts();
    if(a.length===0) return;
    let changed=false;
    for(const it of a){
      if(it.fired) continue;
      const px = lastPrices[it.sym];
      if(!px) continue;
      if(it.dir === ">" && px > it.px){ it.fired=true; changed=true; toast(`ðŸ”” ${it.sym} crossed ABOVE ${gbp(it.px)} (now ${gbp(px)})`); }
      if(it.dir === "<" && px < it.px){ it.fired=true; changed=true; toast(`ðŸ”” ${it.sym} crossed BELOW ${gbp(it.px)} (now ${gbp(px)})`); }
    }
    if(changed) setAlerts(a);
  }

  function getPosOpened(){
    const raw = localStorage.getItem(KEY.posOpened);
    return raw ? JSON.parse(raw) : {};
  }
  function setPosOpened(o){ localStorage.setItem(KEY.posOpened, JSON.stringify(o)); }

  function getTimeframe(){
    const v = localStorage.getItem(KEY.timeframe);
    if(!v){ localStorage.setItem(KEY.timeframe, "1h"); return "1h"; }
    return v;
  }
  function setTimeframe(tf){
    localStorage.setItem(KEY.timeframe, tf);
    syncTimeframeButtons();
    drawSparkline();
  }
  function syncTimeframeButtons(){
    const tf = getTimeframe();
    ["1m","5m","1h","1d"].forEach(x=>{
      const b = document.getElementById("tf_"+x);
      if(!b) return;
      if(x===tf) b.classList.add("active");
      else b.classList.remove("active");
    });
  }

  function sessionInitIfNeeded(){
    const ts = localStorage.getItem(KEY.sessionStartTs);
    if(!ts){
      localStorage.setItem(KEY.sessionStartTs, String(Date.now()));
      // equity set after first renderPortfolio; placeholder
      localStorage.setItem(KEY.sessionStartEq, String(0));
    }
  }
  function setSessionStartEquity(eq){
    localStorage.setItem(KEY.sessionStartEq, String(eq));
  }
  function getSessionStartEquity(){ return Number(localStorage.getItem(KEY.sessionStartEq) || "0"); }
  function getSessionStartTs(){ return Number(localStorage.getItem(KEY.sessionStartTs) || "0"); }


  function marketStatus(sym){
    if(sym.startsWith("X:")) return "Market: 24/7 (Crypto)";
    if(sym.startsWith("C:")) return "Market: 24/5 (FX/Metals)";
    // US equities (NYSE/Nasdaq) using NY timezone
    try{
      const parts = new Intl.DateTimeFormat('en-US',{
        timeZone:'America/New_York',
        weekday:'short',
        hour:'2-digit',
        minute:'2-digit',
        hour12:false
      }).formatToParts(new Date());
      const wd = parts.find(p=>p.type==='weekday')?.value || "";
      const hh = Number(parts.find(p=>p.type==='hour')?.value || "0");
      const mm = Number(parts.find(p=>p.type==='minute')?.value || "0");
      const mins = hh*60 + mm;
      const open = (wd!=='Sat' && wd!=='Sun' && mins >= (9*60+30) && mins < (16*60));
      return open ? "Market: OPEN (US)" : "Market: CLOSED (US)";
    }catch{
      return "Market: â€”";
    }
  }

  function currencyNote(sym){
    const gbpPx = lastPrices[sym];
    const nat = lastNativeUSD[sym];
    if(sym.startsWith("X:") || sym.startsWith("C:") || !sym.startsWith("C:")){
      if(nat && gbpPx){
        return `USD ${nat.toFixed(4)} â†’ GBP ${gbpPx.toFixed(4)}`;
      }
    }
    if(gbpPx) return `GBP ${gbpPx.toFixed(4)}`;
    return "â€”";
  }


  function getNames(){ const raw = localStorage.getItem(KEY.names); return raw ? JSON.parse(raw) : {}; }
  function setNames(map){ localStorage.setItem(KEY.names, JSON.stringify(map)); }
  function nameOf(sym){
    const map = getNames();
    return map[sym] || (sym.startsWith("X:") ? "Crypto" : sym.startsWith("C:") ? "FX / Metals" : "Stock");
  }
  function rememberName(sym, fullName){
    if(!sym || !fullName) return;
    const map = getNames();
    map[sym] = fullName;
    setNames(map);
  }

  function loadApiKey(){ const v = localStorage.getItem(KEY.api) || ""; document.getElementById("apiKey").value = v; return v; }
  function saveApiKey(){ const v = document.getElementById("apiKey").value.trim(); localStorage.setItem(KEY.api, v); toast("API key saved locally."); return v; }

  function getCash(){ const v = localStorage.getItem(KEY.cash); if(v===null){ localStorage.setItem(KEY.cash, String(DEFAULT_CASH)); return DEFAULT_CASH; } return Number(v); }
  function setCash(v){ localStorage.setItem(KEY.cash, String(v)); }

  function getPositions(){ const raw = localStorage.getItem(KEY.pos); return raw ? JSON.parse(raw) : {}; }
  function setPositions(p){ localStorage.setItem(KEY.pos, JSON.stringify(p)); }

  function getHistory(){ const raw = localStorage.getItem(KEY.hist); return raw ? JSON.parse(raw) : []; }
  function setHistory(h){ localStorage.setItem(KEY.hist, JSON.stringify(h)); }

  function getWatchlist(){
    const raw = localStorage.getItem(KEY.watch);
    if(!raw){
      const seed=["AAPL","TSLA","NVDA","X:BTCUSD","C:XAUUSD"];
      localStorage.setItem(KEY.watch, JSON.stringify(seed));
      rememberName("AAPL","Apple Inc.");
      rememberName("TSLA","Tesla, Inc.");
      rememberName("NVDA","NVIDIA Corporation");
      rememberName("X:BTCUSD","Bitcoin / USD");
      rememberName("C:XAUUSD","Gold / USD");
      return seed;
    }
    return JSON.parse(raw);
  }
  function setWatchlist(w){ localStorage.setItem(KEY.watch, JSON.stringify(w)); }

  function getActiveSymbol(){ return (localStorage.getItem(KEY.active) || "AAPL").toUpperCase(); }
  function setActiveSymbol(sym){
    sym = (sym||"").trim().toUpperCase();
    if(!sym) return;
    localStorage.setItem(KEY.active, sym);
    const w = getWatchlist();
    if(!w.includes(sym)){ w.push(sym); setWatchlist(w); }
    syncActiveHeader();
    renderWatch();
    refreshPrices();
    toast(`Active: ${sym}`);
  }

  function getSeries(){ const raw = localStorage.getItem(KEY.series); return raw ? JSON.parse(raw) : {}; }
  function setSeries(s){ localStorage.setItem(KEY.series, JSON.stringify(s)); }

  function gbp(n){ if(!isFinite(n)) return "â€”"; return new Intl.NumberFormat("en-GB",{ style:"currency", currency:"GBP" }).format(n); }
  function pct(n){ if(!isFinite(n)) return "â€”"; const sign = n>=0?"+":""; return sign + (n*100).toFixed(2) + "%"; }

  function toast(msg){
    const t = document.getElementById("globalToast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2600);
  }
  
  function modalError(msg){
    const box = document.getElementById("modalError");
    if(!box) return;
    if(!msg){ box.textContent=""; box.classList.remove("show"); return; }
    box.textContent = msg;
    box.classList.add("show");
  }

  function setLive(on){
    const dot = document.getElementById("liveDot");
    const text = document.getElementById("liveText");
    if(on){ dot.classList.remove("off"); text.textContent="Live updating"; }
    else { dot.classList.add("off"); text.textContent="Not updating"; }
  }

  function showView(view){
    const views = ["Markets","Discover","Watch","Portfolio","History"];
    views.forEach(v=>{
      document.getElementById("view"+v).style.display = (v.toLowerCase()===view) ? "block" : "none";
    });
    ["Markets","Discover","Watch","Port","Hist"].forEach(v=>{
      const el = document.getElementById("nav"+v);
      if(el) el.classList.remove("active");
    });
    if(view==="markets") document.getElementById("navMarkets").classList.add("active");
    if(view==="discover") document.getElementById("navDiscover").classList.add("active");
    if(view==="watch") document.getElementById("navWatch").classList.add("active");
    if(view==="portfolio") document.getElementById("navPort").classList.add("active");
    if(view==="history") document.getElementById("navHist").classList.add("active");
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function renderWatch(){
    const tags = document.getElementById("watchTags");
    tags.innerHTML = "";
    getWatchlist().forEach(sym=>{
      const price = lastPrices[sym];
      const nm = nameOf(sym);

      const el = document.createElement("div");
      el.className = "tag";
      el.innerHTML = `
        <div class="col">
          <b>${sym}</b>
          <span class="small">${escapeHtml(nm)}</span>
        </div>
        <div class="col" style="align-items:flex-end;">
          <span class="price">${price ? gbp(price) : "â€”"}</span>
          <span class="small muted">tap</span>
        </div>
        <span class="x" title="Remove">âœ•</span>
      `;
      el.onclick = ()=>setActiveSymbol(sym);
      el.querySelector(".x").onclick = (ev)=>{ ev.stopPropagation(); removeWatch(sym); };
      tags.appendChild(el);
    });
  }

  function renderPortfolio(){
    const cash = getCash();
    const positions = getPositions();
    let mkt=0;

    const body = document.getElementById("portfolioBody");
    body.innerHTML = "";

    const syms = Object.keys(positions).sort();
    if(syms.length===0){
      body.innerHTML = `<tr><td colspan="6" class="muted">No positions yet.</td></tr>`;
    } else {
      syms.forEach(sym=>{
        const sh = positions[sym].shares;
        const avg = positions[sym].avg;
        const px = lastPrices[sym];

        const value = (px?px:0)*sh;
        const basis = avg*sh;
        const upl = value - basis;

        mkt += value;

        const tr = document.createElement("tr");
        const nm = nameOf(sym);
        tr.innerHTML = `
          <td><b>${sym}</b><div class="small muted">${escapeHtml(nm)}</div></td>
          <td class="right">${Number(sh).toFixed(6)}</td>
          <td class="right">${gbp(avg)}</td>
          <td class="right">${px ? gbp(px) : "â€”"}</td>
          <td class="right">${px ? gbp(value) : "â€”"}</td>
          <td class="right ${upl>=0 ? "pos":"neg"}">${px ? gbp(upl) : "â€”"}</td>
        `;
        tr.style.cursor = "pointer";
        tr.addEventListener("click", ()=>openPositionModal(sym));
        body.appendChild(tr);
      });
    }

    const equity = cash + mkt;

    // Session P/L
    const sessStart = getSessionStartEquity();
    if(sessStart === 0){ setSessionStartEquity(equity); }
    const sessPL = equity - getSessionStartEquity();
    const sessEl = document.getElementById("sessionPL");
    if(sessEl) sessEl.textContent = gbp(sessPL);
    const stTs = getSessionStartTs();
    const stEl = document.getElementById("sessionStart");
    if(stEl && stTs) stEl.textContent = new Date(stTs).toLocaleTimeString();

    // Performance metrics
    const startCash = getStartCash();
    const totalReturn = (equity - startCash);
    const totalReturnPct = startCash > 0 ? (totalReturn / startCash) : 0;
    const perfReturn = document.getElementById("perfReturn");
    const perfUPL = document.getElementById("perfUPL");
    const perfBestWorst = document.getElementById("perfBestWorst");
    if(perfReturn) perfReturn.textContent = `${gbp(totalReturn)} (${(totalReturnPct*100).toFixed(2)}%)`;
    if(perfUPL) perfUPL.textContent = gbp(Object.keys(positions).reduce((acc,s)=>{
      const sh = positions[s].shares; const avg = positions[s].avg; const px = lastPrices[s]||0;
      return acc + (px*sh - avg*sh);
    },0));

    // Best / worst by unrealized P/L
    let best = null, worst = null;
    for(const s of Object.keys(positions)){
      const sh = positions[s].shares; const avg = positions[s].avg; const px = lastPrices[s]||0;
      const upl = (px*sh - avg*sh);
      if(best===null || upl > best.upl) best = {s,upl};
      if(worst===null || upl < worst.upl) worst = {s,upl};
    }
    if(perfBestWorst){
      if(best && worst){
        perfBestWorst.textContent = `Best: ${best.s} ${gbp(best.upl)} â€¢ Worst: ${worst.s} ${gbp(worst.upl)}`;
      } else {
        perfBestWorst.textContent = "â€”";
      }
    }

    document.getElementById("cashTop").textContent = gbp(cash);
    document.getElementById("equityTop").textContent = gbp(equity);
    document.getElementById("asOf").textContent = new Date().toLocaleTimeString();
  }

  function renderHistory(){
    const h = getHistory().slice().reverse();
    const body = document.getElementById("historyBody");
    body.innerHTML = "";
    if(h.length===0){
      body.innerHTML = `<tr><td colspan="6" class="muted">No trades yet.</td></tr>`;
      return;
    }
    h.slice(0,50).forEach(t=>{
      const tr = document.createElement("tr");
      const nm = nameOf(t.symbol);
      tr.innerHTML = `
        <td class="muted">${new Date(t.ts).toLocaleString()}</td>
        <td><b class="${t.side==="BUY" ? "pos":"neg"}">${t.side}</b></td>
        <td><b>${t.symbol}</b><div class="small muted">${escapeHtml(nm)}</div></td>
        <td class="right">${gbp(t.amount_gbp)}</td>
        <td class="right">${Number(t.shares).toFixed(6)}</td>
        <td class="right">${gbp(t.price_gbp)}</td>
      `;
      tr.style.cursor = "pointer";
        tr.addEventListener("click", ()=>openPositionModal(sym));
        body.appendChild(tr);
    });
  }

  function renderMarketChips(){
    const chips = ["AAPL","TSLA","NVDA","X:BTCUSD","C:XAUUSD"];
    chips.forEach(sym=>{
      const p = lastPrices[sym];
      const el = document.getElementById("px_"+sym);
      if(el) el.textContent = p ? gbp(p) : "â€”";
      const nmEl = document.getElementById("nm_"+sym);
      if(nmEl) nmEl.textContent = nameOf(sym);
    });
  }

  function syncActiveHeader(){
    const sym = getActiveSymbol();
    document.getElementById("assetSym").textContent = sym;
    document.getElementById("assetName").textContent = nameOf(sym);

    const px = lastPrices[sym];
    document.getElementById("assetPrice").textContent = px ? gbp(px) : "Â£â€”";

    let seriesFull = (getSeries()[sym] || []);
    const tf = getTimeframe();
    let take = 60;
    if(tf==="1m") take = 60;
    if(tf==="5m") take = 120;
    if(tf==="1h") take = 240;
    if(tf==="1d") take = 480;
    const series = seriesFull.slice(-take);
    const el = document.getElementById("assetChange");
    if(series.length >= 2){
      const a = series[series.length-2], b = series[series.length-1];
      const ch = (b-a)/a;
      el.textContent = pct(ch);
      el.className = "assetChange " + (ch>=0 ? "pos":"neg");
    } else {
      el.textContent = "â€”";
      el.className = "assetChange muted";
    }
    document.getElementById("marketStatus").textContent = marketStatus(sym);
    document.getElementById("currencyNote").textContent = currencyNote(sym);
    drawSparkline();
    syncTicket();
  }

  function drawSparkline(){
    const sym = getActiveSymbol();
    const canvas = document.getElementById("spark");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    let seriesFull = (getSeries()[sym] || []);
    const tf = getTimeframe();
    let take = 60;
    if(tf==="1m") take = 60;
    if(tf==="5m") take = 120;
    if(tf==="1h") take = 240;
    if(tf==="1d") take = 480;
    const series = seriesFull.slice(-take);
    if(series.length < 2){
      ctx.fillStyle = "#9bb0d0";
      ctx.font = "12px ui-sans-serif";
      ctx.fillText("No data yet â€” press Refresh or Start.", 10, 55);
      return;
    }

    const min = Math.min(...series);
    const max = Math.max(...series);
    const pad = 8;
    const W = canvas.width, H = canvas.height;

    function x(i){ return pad + (i*(W-2*pad)/(series.length-1)); }
    function y(v){
      if(max === min) return H/2;
      const t = (v - min) / (max - min);
      return (H - pad) - t*(H-2*pad);
    }

    ctx.globalAlpha = 0.35;
    ctx.strokeStyle = "#1f2a3d";
    ctx.beginPath();
    for(let i=1;i<=3;i++){
      const yy = pad + i*(H-2*pad)/4;
      ctx.moveTo(pad, yy); ctx.lineTo(W-pad, yy);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;

    const up = series[series.length-1] >= series[0];
    ctx.lineWidth = 2;
    ctx.strokeStyle = up ? "#27e69a" : "#ff6b6b";
    ctx.beginPath();
    ctx.moveTo(x(0), y(series[0]));
    for(let i=1;i<series.length;i++) ctx.lineTo(x(i), y(series[i]));
    ctx.stroke();

    ctx.fillStyle = ctx.strokeStyle;
    ctx.beginPath();
    ctx.arc(x(series.length-1), y(series[series.length-1]), 3.5, 0, Math.PI*2);
    ctx.fill();
  }

  function renderAll(){
    renderWatch();
    renderPortfolio();
    renderHistory();
    renderMarketChips();
    syncActiveHeader();
  }

  function isCrypto(sym){ return sym.startsWith("X:"); }
  function isForex(sym){ return sym.startsWith("C:"); }
  function parsePair(sym){
    const s = sym.split(":")[1] || "";
    return {from: s.slice(0,3), to: s.slice(3,6)};
  }

  async function stockLastTradeUSD(symbol, apiKey){
    const url = `https://api.polygon.io/v2/last/trade/${encodeURIComponent(symbol)}?apiKey=${encodeURIComponent(apiKey)}`;
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`Stock last trade failed (${r.status})`);
    const j = await r.json();
    const p = j?.last?.price;
    if(!p) throw new Error("No stock last trade price");
    return Number(p);
  }

  async function cryptoLastTradeUSD(ticker, apiKey){
    const {from, to} = parsePair(ticker);
    const url = `https://api.polygon.io/v1/last/crypto/${encodeURIComponent(from)}/${encodeURIComponent(to)}?apiKey=${encodeURIComponent(apiKey)}`;
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`Crypto last trade failed (${r.status})`);
    const j = await r.json();
    const p = j?.last?.price;
    if(!p) throw new Error("No crypto last trade price");
    return Number(p);
  }

  async function forexLastQuoteMidUSD(ticker, apiKey){
    const {from, to} = parsePair(ticker);
    const url = `https://api.polygon.io/v1/last_quote/currencies/${encodeURIComponent(from)}/${encodeURIComponent(to)}?apiKey=${encodeURIComponent(apiKey)}`;
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`FX last quote failed (${r.status})`);
    const j = await r.json();
    const bid = j?.last?.bid;
    const ask = j?.last?.ask;
    if(!(bid && ask)) throw new Error("No FX bid/ask");
    return (Number(bid) + Number(ask)) / 2.0;
  }

  async function usdToGbp(apiKey){
    const now = Date.now();
    if(usdToGbpCache && (now - usdToGbpTs) < 60000) return usdToGbpCache;
    const url = `https://api.polygon.io/v1/conversion/USD/GBP?amount=1&precision=6&apiKey=${encodeURIComponent(apiKey)}`;
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`USDGBP conversion failed (${r.status})`);
    const j = await r.json();
    const x = j?.converted;
    if(!x) throw new Error("No USD->GBP conversion");
    usdToGbpCache = Number(x);
    usdToGbpTs = now;
    return usdToGbpCache;
  }

  async function fetchPriceGBP(sym, apiKey){
    if(isCrypto(sym)){
      const native = await cryptoLastTradeUSD(sym, apiKey);
      lastNativeUSD[sym] = native;
      return native * await usdToGbp(apiKey);
    }
    if(isForex(sym)){
      const native = await forexLastQuoteMidUSD(sym, apiKey);
      lastNativeUSD[sym] = native;
      return native * await usdToGbp(apiKey);
    }
    const native = await stockLastTradeUSD(sym, apiKey);
    lastNativeUSD[sym] = native;
    return native * await usdToGbp(apiKey);
  }

  async function refreshPrices(){
    const apiKey = document.getElementById("apiKey").value.trim();
    const demo = getDemoMode();

    const active = getActiveSymbol();
    const watch = Array.from(new Set([...getWatchlist(), ...Object.keys(getPositions()), active]))
      .map(s=>s.toUpperCase());

    // DEMO path (no key required)
    if((!apiKey || apiKey.length===0) && demo==="on"){
      const p = stepDemoPrices(watch);
      for(const sym of watch){
        lastPrices[sym] = Number(p[sym]);
        lastNativeUSD[sym] = null;
        const seriesAll = getSeries();
        const arr = seriesAll[sym] || [];
        arr.push(lastPrices[sym]);
        seriesAll[sym] = arr.slice(-240);
        setSeries(seriesAll);
      }
      updateStatusPills();
      renderAll();

  // Timeframe buttons
  const tfMap = {"tf_1m":"1m","tf_5m":"5m","tf_1h":"1h","tf_1d":"1d"};
  for(const id in tfMap){
    const b = document.getElementById(id);
    if(b) b.addEventListener("click", ()=>setTimeframe(tfMap[id]));
  }
      checkAlerts();
      return;
    }

    if(!apiKey){
      updateStatusPills();
      toast("Paste your API key (or turn Demo Mode ON).");
      return;
    }

    localStorage.setItem(KEY.api, apiKey);
    updateStatusPills();

    try{
      for(const sym of watch){
        try{
          const gbpPx = await fetchPriceGBP(sym, apiKey);
          lastPrices[sym] = gbpPx;

          const seriesAll = getSeries();
          const arr = seriesAll[sym] || [];
          arr.push(gbpPx);
          seriesAll[sym] = arr.slice(-240);
          setSeries(seriesAll);
        } catch(e){
          console.warn("Price fetch failed", sym, e);
        }
      }
      renderAll();
      checkAlerts();
    } catch(e){
      console.error(e);
      toast("Price update failed (key/plan/rate limits).");
      setLive(false);
      stopLive(false);
    }
  }

  function startLive(){
    setDemoMode("off");
    saveApiKey();
    const ms = Number(document.getElementById("interval").value);
    stopLive(false);
    setLive(true);
    refreshPrices();
    timer = setInterval(refreshPrices, ms);
    toast(`Live updates started (${ms/1000}s).`);
  }
  function stopLive(showToast=true){
    if(timer) clearInterval(timer);
    timer = null;
    setLive(false);
    if(showToast) toast("Live updates stopped.");
  }

  function quickAdd(){
    const sym = (document.getElementById("globalSymbol").value || "").trim().toUpperCase();
    if(!sym) return toast("Type a symbol first.");
    const w = getWatchlist();
    if(!w.includes(sym)) w.push(sym);
    setWatchlist(w);
    document.getElementById("globalSymbol").value = "";
    toast(`Added ${sym} to watchlist.`);
    renderWatch();
    refreshPrices();
  }
  function removeWatch(sym){
    const w = getWatchlist().filter(x=>x!==sym);
    setWatchlist(w);
    renderWatch();
  }
  function addFunds(amount){
    setCash(getCash() + Number(amount));
    toast(`Added ${gbp(amount)} virtual funds.`);
    renderPortfolio();
  }
  function resetAccount(){
    if(!confirm("Reset portfolio and cash back to Â£100,000?")) return;
    setCash(DEFAULT_CASH);
    setStartCash(DEFAULT_CASH);
    setPositions({});
    setHistory([]);
    setSeries({});
    lastPrices = {};
    toast("Reset complete.");
    renderAll();
  }

  function openTicket(side){
    modalError(null);
    document.getElementById("backdrop").classList.add("show");
    document.getElementById("ticketSide").value = side || "BUY";
    document.getElementById("ticketSymbol").value = getActiveSymbol();
    document.getElementById("ticketAmount").value = "1000";
    syncTicket();
  }
  function closeTicket(){ document.getElementById("backdrop").classList.remove("show"); }

  function requirePrice(sym){
    const p = lastPrices[sym];
    if(!p || !isFinite(p)) throw new Error("No live price yet. Press Refresh or Start first.");
    return p;
  }

  function syncTicket(){
    const sym = (document.getElementById("ticketSymbol").value||"").trim().toUpperCase();
    const side = document.getElementById("ticketSide").value;
    const amount = Number(document.getElementById("ticketAmount").value);

    const price = lastPrices[sym];
    document.getElementById("ticketPrice").value = price ? gbp(price) : "â€”";

    if(!(price && isFinite(amount) && amount>0)){
      document.getElementById("ticketSharesCalc").textContent = "â€”";
      document.getElementById("cashAfter").textContent = "â€”";
      return;
    }

    const shares = amount / price;
    document.getElementById("ticketSharesCalc").textContent = shares.toFixed(6);

    const cash = getCash();
    document.getElementById("cashAfter").textContent = (side==="BUY") ? gbp(cash - amount) : gbp(cash + amount);
  }

  document.getElementById("ticketSide").addEventListener("change", syncTicket);
  document.getElementById("ticketSymbol").addEventListener("input", syncTicket);
  document.getElementById("ticketAmount").addEventListener("input", syncTicket);

  function submitTicket(){
    const side = document.getElementById("ticketSide").value;
    const sym = (document.getElementById("ticketSymbol").value||"").trim().toUpperCase();
    const amount = Number(document.getElementById("ticketAmount").value);

    if(!sym || !isFinite(amount) || amount<=0) return toast("Enter a valid symbol and Â£ amount.");

    let price;
    try{ price = requirePrice(sym); } catch(e){ const m = e.message || String(e); modalError(m); toast(m); return; }

    const sharesPreview = amount / price;
    const cash = getCash();
    const cashAfter = (side==="BUY") ? (cash - amount) : (cash + amount);
    const equityNow = (function(){
      const positions = getPositions();
      let mkt=0;
      for(const s of Object.keys(positions)){
        const sh = positions[s].shares; const px2 = lastPrices[s]||0;
        mkt += sh*px2;
      }
      return getCash()+mkt;
    })();
    const riskPct = equityNow>0 ? (amount/equityNow)*100 : 0;
    const summary = `${side} ${gbp(amount)} of ${sym}\nâ‰ˆ ${sharesPreview.toFixed(6)} shares @ ${gbp(price)}\nRisk: ${riskPct.toFixed(2)}% of equity\nCash after: ${gbp(cashAfter)}`;
    if(!confirm(summary)) return;

    if(side==="BUY") buyByAmount(sym, amount, price);
    else sellByAmount(sym, amount, price);

    closeTicket();
    renderAll();
  }

  function buyByAmount(sym, amount, price){
    const cash = getCash();
    if(amount > cash + 1e-9) return toast(`Not enough cash. You have ${gbp(cash)}.`);

    const shares = amount / price;

    const positions = getPositions();
    const pos = positions[sym];
    if(!pos){
      positions[sym] = { shares: shares, avg: price };
      const opened = getPosOpened();
      if(!opened[sym]){ opened[sym] = Date.now(); setPosOpened(opened); }
    } else {
      const newShares = pos.shares + shares;
      const newAvg = ((pos.shares*pos.avg) + (shares*price)) / newShares;
      positions[sym] = { shares:newShares, avg:newAvg };
    }
    setCash(cash - amount);
    setPositions(positions);

    const hist = getHistory();
    hist.push({ ts: Date.now(), side:"BUY", symbol:sym, amount_gbp:amount, shares:shares, price_gbp:price });
    setHistory(hist);

    const w = getWatchlist();
    if(!w.includes(sym)) { w.push(sym); setWatchlist(w); }

    toast(`âœ… Bought ~${shares.toFixed(6)} ${sym} for ${gbp(amount)}`);
  }

  function sellByAmount(sym, amount, price){
    const positions = getPositions();
    const pos = positions[sym];
    if(!pos) return toast(`You have no position in ${sym}.`);

    const maxProceeds = pos.shares * price;
    const proceeds = Math.min(amount, maxProceeds);
    const sharesToSell = proceeds / price;

    setCash(getCash() + proceeds);

    const remaining = pos.shares - sharesToSell;
    if(remaining <= 1e-9){
      delete positions[sym];
      const opened = getPosOpened();
      if(opened[sym]){ delete opened[sym]; setPosOpened(opened); }
    }
    else positions[sym] = { shares: remaining, avg: pos.avg };
    setPositions(positions);

    const hist = getHistory();
    hist.push({ ts: Date.now(), side:"SELL", symbol:sym, amount_gbp:proceeds, shares:sharesToSell, price_gbp:price });
    setHistory(hist);

    toast(amount > maxProceeds + 1e-9 ? `âœ… Sold max possible: ${gbp(proceeds)} (all shares)` : `âœ… Sold ~${sharesToSell.toFixed(6)} ${sym} for ${gbp(proceeds)}`);
  }

  // Discover
  let discCursor = null;
  let discPage = 1;
  let discLastQuery = null;
  function discStateSave(){ localStorage.setItem(KEY.discState, JSON.stringify({cursor:discCursor,page:discPage,lastQuery:discLastQuery})); }
  function discStateLoad(){
    const raw = localStorage.getItem(KEY.discState);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      discCursor = s.cursor || null;
      discPage = s.page || 1;
      discLastQuery = s.lastQuery || null;
      document.getElementById("discPage").textContent = `Page ${discPage}`;
    }catch{}
  }

  function jsEsc(s){
    return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'").replaceAll('"','\\"');
  }

  async function discoverSearch(reset=true){
    const apiKey = document.getElementById("apiKey").value.trim();
    if(!apiKey){ toast("Paste your API key first."); return; }

    const q = (document.getElementById("discQuery").value || "").trim();
    const asset = document.getElementById("discAsset").value;
    const locale = document.getElementById("discLocale").value;

    if(reset){
      discCursor = null;
      discPage = 1;
    }
    discLastQuery = {q, asset, locale};

    const market = (asset === "stocks") ? "stocks" : (asset === "crypto") ? "crypto" : "fx";
    const params = new URLSearchParams();
    if(q) params.set("search", q);
    params.set("active", "true");
    params.set("limit", "50");
    params.set("market", market);
    if(locale) params.set("locale", locale);
    if(discCursor) params.set("cursor", discCursor);
    params.set("apiKey", apiKey);

    const url = `https://api.polygon.io/v3/reference/tickers?${params.toString()}`;
    const box = document.getElementById("discResults");
    box.innerHTML = `<div style="padding:12px" class="muted">Loadingâ€¦</div>`;

    try{
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error(`Reference tickers failed (${r.status})`);
      const j = await r.json();

      discCursor = j?.next_url ? new URL(j.next_url).searchParams.get("cursor") : null;
      document.getElementById("discPage").textContent = `Page ${discPage}`;
      discStateSave();

      const results = j?.results || [];
      if(results.length === 0){
        box.innerHTML = `<div style="padding:12px" class="muted">No results â€” try another search.</div>`;
        return;
      }

      let html = "";
      for(const it of results){
        const sym = (it.ticker || "").toUpperCase();
        const fullName = it.name || sym;
        const ex = it.primary_exchange || it.market || market;
        html += `
          <div style="padding:12px; border-bottom:1px solid var(--line); display:flex; gap:10px; justify-content:space-between; align-items:center;">
            <div style="display:flex; flex-direction:column; gap:4px;">
              <b>${sym}</b>
              <span class="muted" style="font-size:12px;">${escapeHtml(fullName)}</span>
              <span class="small muted">${escapeHtml(ex)}</span>
            </div>
            <div class="row">
              <button class="btn ghost" onclick="addSymbolFromDiscover('${jsEsc(sym)}','${jsEsc(fullName)}')">Add</button>
              <button class="btn" onclick="openSymbolFromDiscover('${jsEsc(sym)}','${jsEsc(fullName)}')">Open</button>
            </div>
          </div>
        `;
      }
      box.innerHTML = html;
    } catch(e){
      console.error(e);
      box.innerHTML = `<div style="padding:12px" class="muted">Discover failed. Your plan may not allow reference searches for this market/locale.</div>`;
    }
  }

  function discoverNext(){
    if(!discLastQuery) return discoverSearch(true);
    discPage += 1;
    discoverSearch(false);
  }
  function discoverPrev(){
    discPage = 1;
    discCursor = null;
    discoverSearch(true);
  }

  function addSymbolFromDiscover(sym, fullName){
    sym = (sym||"").trim().toUpperCase();
    rememberName(sym, fullName);
    const w = getWatchlist();
    if(!w.includes(sym)) w.push(sym);
    setWatchlist(w);
    toast(`Added ${sym}`);
    renderWatch();
    refreshPrices();
  }
  function openSymbolFromDiscover(sym, fullName){
    sym = (sym||"").trim().toUpperCase();
    rememberName(sym, fullName);
    setActiveSymbol(sym);
    showView("watch");
  }

  
  function openPositionModal(sym){
    const positions = getPositions();
    const pos = positions[sym];
    if(!pos){ toast("No position."); return; }
    const openedMap = getPosOpened();
    const openedTs = openedMap[sym] || null;

    const px = lastPrices[sym] || 0;
    const value = px * pos.shares;
    const basis = pos.avg * pos.shares;
    const pl = value - basis;
    const pct = basis>0 ? (pl/basis) : 0;

    document.getElementById("posTitle").textContent = `${sym} â€” ${nameOf(sym)}`;
    document.getElementById("posSub").textContent = `Value: ${gbp(value)} â€¢ Basis: ${gbp(basis)}`;
    document.getElementById("posShares").textContent = Number(pos.shares).toFixed(6);
    document.getElementById("posAvg").textContent = gbp(pos.avg);
    document.getElementById("posPx").textContent = px ? gbp(px) : "â€”";
    const plEl = document.getElementById("posPL");
    plEl.textContent = gbp(pl);
    plEl.className = pl>=0 ? "pos" : "neg";
    const pctEl = document.getElementById("posPct");
    pctEl.textContent = (pct*100).toFixed(2) + "%";
    pctEl.className = pct>=0 ? "pos" : "neg";
    document.getElementById("posOpened").textContent = openedTs ? new Date(openedTs).toLocaleString() : "â€”";

    localStorage.setItem("papertrading_pos_modal_sym", sym);
    document.getElementById("posBackdrop").classList.add("show");
  }
  function closePositionModal(){ document.getElementById("posBackdrop").classList.remove("show"); }

  function closePositionPercent(pct){
    const sym = localStorage.getItem("papertrading_pos_modal_sym");
    if(!sym) return;
    const positions = getPositions();
    const pos = positions[sym];
    if(!pos) return;
    const px = lastPrices[sym];
    if(!px){ toast("No live price yet."); return; }
    const value = pos.shares * px;
    const amount = value * (pct/100);
    const summary = `SELL ${pct}% of ${sym}\nâ‰ˆ ${gbp(amount)} at ${gbp(px)}\nProceed?`;
    if(!confirm(summary)) return;
    sellByAmount(sym, amount, px);
    renderAll();
    // refresh modal
    const still = getPositions()[sym];
    if(still) openPositionModal(sym);
    else closePositionModal();
  }

  // init
  document.getElementById("startBtn").addEventListener("click", startLive);
  document.getElementById("stopBtn").addEventListener("click", ()=>stopLive(true));
  const tb = document.getElementById("testBtn");
  if(tb) tb.addEventListener("click", ()=>{ toast("Refreshing pricesâ€¦"); refreshPrices(); });
  document.getElementById("apiKey").addEventListener("change", ()=>{ saveApiKey(); updateStatusPills(); });
  const dm = document.getElementById("demoMode");
  if(dm){ dm.addEventListener("change", ()=>{ setDemoMode(dm.value); }); }

  document.getElementById("globalSymbol").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ quickAdd(); }
  });

  loadApiKey();
  getStartCash();
  getCash();
  const dmSel = document.getElementById("demoMode");
  if(dmSel) dmSel.value = getDemoMode();
  const thSel = document.getElementById("themeMode");
  if(thSel){ thSel.value = getTheme(); thSel.addEventListener("change", ()=>setTheme(thSel.value)); }
  setTheme(getTheme());
  updateStatusPills();
  sessionInitIfNeeded();
  renderAlerts();
  syncTimeframeButtons();
  getWatchlist();
  if(!localStorage.getItem(KEY.active)) localStorage.setItem(KEY.active, "AAPL");
  discStateLoad();

  // Auto-refresh once on load if key exists
  const k = localStorage.getItem(KEY.api);
  if(k && k.trim().length > 0){
    setTimeout(()=>refreshPrices(), 400);
  }

  renderAll();

  // Keep ticket synced
  document.getElementById("ticketSide").addEventListener("change", syncTicket);
  document.getElementById("ticketSymbol").addEventListener("input", syncTicket);
  document.getElementById("ticketAmount").addEventListener("input", syncTicket);
</script>
<div id="globalToast" class="globalToast"></div>

<div id="posBackdrop" class="backdrop" onclick="closePositionModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalTop">
      <div>
        <div style="font-weight:1100; font-size:16px;" id="posTitle">Position</div>
        <div class="muted small" id="posSub">â€”</div>
      </div>
      <button class="xbtn" onclick="closePositionModal()">âœ•</button>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="muted">Shares</div>
        <b id="posShares">â€”</b>
      </div>
      <div class="kpi">
        <div class="muted">Avg cost</div>
        <b id="posAvg">â€”</b>
      </div>
      <div class="kpi">
        <div class="muted">Current</div>
        <b id="posPx">â€”</b>
      </div>
      <div class="kpi">
        <div class="muted">P/L</div>
        <b id="posPL">â€”</b>
      </div>
      <div class="kpi">
        <div class="muted">% Return</div>
        <b id="posPct">â€”</b>
      </div>
      <div class="kpi">
        <div class="muted">Opened</div>
        <b id="posOpened">â€”</b>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" style="flex:1;" onclick="closePositionPercent(25)">Close 25%</button>
      <button class="btn ghost" style="flex:1;" onclick="closePositionPercent(50)">Close 50%</button>
      <button class="btn danger" style="flex:1;" onclick="closePositionPercent(100)">Close 100%</button>
    </div>

    <div class="warn">
      Close buttons sell by Â£ amount at the latest fetched price.
    </div>
  </div>
</div>

</body>
</html>
